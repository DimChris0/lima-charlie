# Re-generate new C2 TLS Cert

Due to a bug in release 3.0, the TLS certs generated by default had a 1 month expiry. To fix this, you need to:
1. Re-generate a new TLS cert
2. Update the LC Database with the new cert
3. Re-generate sensors
4. Re-install sensors

## 1 - Re-Generate New TLS Cert
```
openssl req -x509 -days 36500 -newkey rsa:4096 -keyout new_key.pem -out new_cert.pem -nodes -sha256 -subj "/C=US/ST=CA/L=Mountain View/O=refractionPOINT/CN=rp_c2_dev"
```

## 2 - Update the LC Database with the New Cert
Using the small python script below, let's call it `fix_c2.py`:
```
import base64
import msgpack
import sys
print(base64.b64encode(msgpack.packb({ 'cert' : open(sys.argv[ 1 ]).read(), 'key' : open(sys.argv[ 2 ]).read() })))
```

Run the script on your LC server:

```
python fix_c2.py new_cert.pem new_key.pem
```

Then copy the output from the script to your clipboard.

Execute the following command, but replace the XXXXXXX with the output from command above.

```
cqlsh -k hcp_analytics -e "UPDATE configs SET value = 'XXXXXXXXXXX' WHERE conf = 'key/c2'"
```

This should do it, restarting the server (replace `/home/user/lc` with the path to the LC repo):
```
sudo killall python
python /home/user/limacharlie/infrastructure/2_start_single_node_test_cluster.py
```

## 3 - Re-Generate the Sensors
In the web ui, go to your profile (you must be admin). There in the panel Generate Sensors, select your organizations and click "RE GENERATE".

## 4 - Re-Install Sensors
We're really sorry this is a problem, but you'll have to download and re-install the sensors.

