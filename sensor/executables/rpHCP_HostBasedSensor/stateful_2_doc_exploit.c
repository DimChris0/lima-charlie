/*
Copyright 2015 refractionPOINT

Licensed under the Apache License, Version 2.0 ( the "License" );
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

http ://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/

#include "stateful_framework.h"
#include "stateful_helpers.h"
#include "stateful_events.h"

#define NEW_PROCESS_NAMED(progMatch,destState) TRANSITION( FALSE, TRUE, FALSE, RP_TAGS_NOTIFICATION_NEW_PROCESS, destState, progMatch, tr_match )
#define NEW_DESCENDANT_NAMED(progMatch,destState) TRANSITION( TRUE, TRUE, FALSE, RP_TAGS_NOTIFICATION_NEW_PROCESS, destState, progMatch, tr_match )

static tr_match_params ancestors[] = {
    EXECUTABLE_MATCHES( "*\\winword.exe" ),
    EXECUTABLE_MATCHES( "*\\outlook.exe" ),
    EXECUTABLE_MATCHES( "*\\chrome.exe" ),
    EXECUTABLE_MATCHES( "*\\iexplore.exe" ),
    EXECUTABLE_MATCHES( "*\\firefox.exe" )
};

static tr_match_params descendants[] = {
    EXECUTABLE_MATCHES( "*\\cmd.exe" ),
    EXECUTABLE_MATCHES( "*\\nslookup.exe" ),
    EXECUTABLE_MATCHES( "*\\ipconfig.exe" )
};

// State 0: New process starting that matches target ancestors
STATE( 0, ARRAY_N_ELEM( ancestors ), 
    NEW_PROCESS_NAMED( ancestors[ 0 ], 1 ),
    NEW_PROCESS_NAMED( ancestors[ 1 ], 1 ),
    NEW_PROCESS_NAMED( ancestors[ 2 ], 1 ),
    NEW_PROCESS_NAMED( ancestors[ 3 ], 1 ),
    NEW_PROCESS_NAMED( ancestors[ 4 ], 1 ),
    NEW_PROCESS_NAMED( ancestors[ 5 ], 1 ) );

// State 1: Modules after X time, if terminated delete (state 0)
STATE( 1, 6, TRANSITION( FALSE,
                         FALSE,
                         TRUE, // Delete FSM if empty
                         RP_TAGS_NOTIFICATION_TERMINATE_PROCESS,
                         0, // This is an ancestor terminating, keep going
                         MATCHING_PID_REMOVE,
                         tr_match ),
             TRANSITION( FALSE,
                         FALSE,
                         FALSE,
                         RP_TAGS_NOTIFICATION_NEW_PROCESS,
                         1, // This is a duplicate pid, remove and keep going
                         MATCHING_PID_REMOVE,
                         tr_match ),
             TRANSITION( FALSE,
                         FALSE,
                         FALSE,
                         RP_TAGS_NOTIFICATION_NEW_PROCESS,
                         1, // This is not a descendant, so keep moving
                         NOT_MATCHING_PARENT_PID,
                         tr_match ),
             // Because the transition above filters out non-descendants, it means any transition
             // below can assume that it is a descendant.
             NEW_DESCENDANT_NAMED( descendants[ 0 ], 1 ),
             NEW_DESCENDANT_NAMED( descendants[ 1 ], 1 ),
             TRANSITION( FALSE,
                         TRUE,
                         FALSE,
                         RP_TAGS_NOTIFICATION_NEW_PROCESS,
                         1, // This is a related descendant process, record it
                         MATCHING_EMPTY,
                         NULL ) );

STATEFUL_MACHINE( 2, STATEFUL_MACHINE_2_EVENT, 2, STATE_PTR( 0 ),
                                                  STATE_PTR( 1 ) );
